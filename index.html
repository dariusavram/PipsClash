<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeLink - Trading Challenge Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom modal styles */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Header -->
    <header class="bg-gray-800 shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex justify-between items-center">
                <div class="text-2xl font-bold text-white">TradeLink</div>
                <div class="hidden md:flex items-center space-x-2">
                    <a href="#" id="nav-dashboard" data-page="dashboard" class="nav-link py-2 px-3 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">Dashboard</a>
                    <a href="#" id="nav-challenges" data-page="challenges" class="nav-link py-2 px-3 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">Challenges</a>
                    <a href="#" id="nav-friends" data-page="friends" class="nav-link py-2 px-3 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">Friends</a>
                    <a href="#" id="nav-trade" data-page="trade" class="nav-link py-2 px-3 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">Trade</a>
                    <button id="login-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg ml-2">
                        Login
                    </button>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-btn" class="text-white focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                        </svg>
                    </button>
                </div>
            </div>
             <!-- Mobile Menu -->
            <div id="mobile-menu" class="md:hidden hidden mt-3 space-y-1">
                <a href="#" id="nav-dashboard-mobile" data-page="dashboard" class="nav-link block py-2 px-3 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">Dashboard</a>
                <a href="#" id="nav-challenges-mobile" data-page="challenges" class="nav-link block py-2 px-3 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">Challenges</a>
                <a href="#" id="nav-friends-mobile" data-page="friends" class="nav-link block py-2 px-3 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">Friends</a>
                <a href="#" id="nav-trade-mobile" data-page="trade" class="nav-link block py-2 px-3 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">Trade</a>
                <button id="login-btn-mobile" class="w-full text-left bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg mt-2">
                    Login
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">

        <!-- Page: Dashboard -->
        <div id="page-dashboard" class="page-content">
            <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <!-- User Profile Card -->
                <div class="md:col-span-1 bg-gray-800 rounded-lg p-6 shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">My Profile</h2>
                    <div id="user-profile" class="space-y-3">
                        <p><strong>Username:</strong> <span id="username-display" class="text-lg font-bold text-indigo-400">Not logged in</span></p>
                        <p><strong>Friend Code:</strong> <span id="friend-code-display" class="text-sm bg-gray-700 px-2 py-1 rounded-md cursor-pointer">N/A</span></p>
                    </div>
                </div>
                 <!-- Stats Card -->
                <div class="md:col-span-2 bg-gray-800 rounded-lg p-6 shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">My Stats (All Time)</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-2xl font-bold text-green-500">+$0.00</p>
                            <p class="text-gray-400">Total P/L</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold">0%</p>
                            <p class="text-gray-400">Win Rate</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold">0</p>
                            <p class="text-gray-400">Challenges Won</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold" id="dashboard-joined-count">0</p>
                            <p class="text-gray-400">Challenges Joined</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-gray-800 rounded-lg p-6 shadow-lg">
                <h2 class="text-xl font-semibold mb-4">My Challenges</h2>
                <div id="dashboard-challenges-list" class="space-y-4">
                    <p class="text-gray-400">You have not joined any challenges yet.</p>
                </div>
            </div>
        </div>

        <!-- Page: Challenges -->
        <div id="page-challenges" class="page-content hidden">
            <h1 class="text-3xl font-bold mb-6">Challenges</h1>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-8">
                    <!-- Create Challenge -->
                    <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Create a New Challenge</h2>
                        <div class="space-y-4">
                            <!-- Form fields -->
                            <div>
                                <label for="challenge-sum" class="block text-sm font-medium text-gray-300">Starting Capital</label>
                                <select id="challenge-sum" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="5000">$5,000</option>
                                    <option value="10000">$10,000</option>
                                    <option value="50000">$50,000</option>
                                    <option value="100000">$100,000</option>
                                    <option value="200000">$200,000</option>
                                </select>
                            </div>
                            <div>
                                <label for="time-limit" class="block text-sm font-medium text-gray-300">Time Limit (days)</label>
                                <input type="number" id="time-limit" value="30" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="max-loss" class="block text-sm font-medium text-gray-300">Max Loss (%)</label>
                                <input type="number" id="max-loss" value="10" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <button id="create-challenge-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Create Challenge</button>
                        </div>
                    </div>
                     <!-- Join by Code -->
                    <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Join with Code</h2>
                        <div class="space-y-3">
                            <input type="text" id="challenge-code-input" placeholder="Enter challenge code" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="join-by-code-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Join Challenge</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">All Public Challenges</h2>
                        <div id="challenges-list" class="space-y-4">
                            <p class="text-gray-400">No active challenges.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Challenge Detail -->
        <div id="page-challenge-detail" class="page-content hidden">
            <button id="back-to-challenges-btn" class="mb-6 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">&larr; Back to Challenges</button>
            <h1 id="challenge-detail-title" class="text-3xl font-bold mb-2">Challenge Details</h1>
            <p id="challenge-detail-info" class="text-gray-400 mb-6"></p>
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Participant Leaderboard</h2>
                <div class="mb-6">
                    <canvas id="leaderboard-chart"></canvas>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3">Filter Participants</h3>
                    <div id="leaderboard-filter" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <!-- Checkboxes will be inserted here -->
                    </div>
                </div>
            </div>
        </div>


        <!-- Page: Friends -->
        <div id="page-friends" class="page-content hidden">
             <h1 class="text-3xl font-bold mb-6">Friends</h1>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Add a Friend</h2>
                        <div class="space-y-3">
                            <input type="text" id="friend-code-input" placeholder="Enter friend's code" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="add-friend-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Add Friend</button>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">My Friends List</h2>
                        <ul id="friends-list" class="space-y-3">
                            <li class="text-gray-400">No friends yet.</li>
                        </ul>
                    </div>
                </div>
             </div>
        </div>
        
        <!-- Page: Trade -->
        <div id="page-trade" class="page-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold">Trade Station</h1>
                <div id="websocket-status" class="flex items-center gap-2 text-sm">
                    <div class="status-light w-3 h-3 rounded-full bg-red-500"></div>
                    <span class="status-text">Disconnected</span>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end mb-6">
                    <!-- Challenge Selection -->
                    <div class="lg:col-span-1">
                        <label for="trade-challenge-select" class="block text-sm font-medium text-gray-300">Select Challenge</label>
                        <select id="trade-challenge-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- No Active Challenges --</option>
                        </select>
                    </div>
                    <!-- Symbol Input -->
                    <div class="lg:col-span-1">
                        <label for="symbol-input" class="block text-sm font-medium text-gray-300">Symbol</label>
                        <input type="text" id="symbol-input" value="AAPL" placeholder="e.g., AAPL, NZDJPY" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <!-- Balance Display -->
                    <div class="text-center">
                        <p class="text-gray-400">Live Equity</p>
                        <p id="trade-equity" class="text-3xl font-bold text-green-500">$0.00</p>
                    </div>
                    <!-- Trade Inputs -->
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                             <label for="lot-size-input" class="block text-sm font-medium text-gray-300">Lot Size</label>
                             <input type="number" id="lot-size-input" value="0.01" step="0.01" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                             <label for="stop-loss-input" class="block text-sm font-medium text-gray-300">Stop Loss</label>
                             <input type="number" id="stop-loss-input" placeholder="Price" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                             <label for="take-profit-input" class="block text-sm font-medium text-gray-300">Take Profit</label>
                             <input type="number" id="take-profit-input" placeholder="Price" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                <!-- Buy/Sell Buttons -->
                 <div class="grid grid-cols-2 gap-4 mb-8">
                    <button id="buy-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-xl disabled:opacity-50 disabled:cursor-not-allowed" disabled>BUY</button>
                    <button id="sell-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg text-xl disabled:opacity-50 disabled:cursor-not-allowed" disabled>SELL</button>
                </div>

                <!-- TradingView Widget -->
                <div class="tradingview-widget-container mb-8" style="height:500px; width:100%;">
                    <div id="tradingview_f4a8c" style="height:100%; width:100%;"></div>
                </div>

                <!-- Open Positions -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Open Positions</h2>
                    <button id="close-all-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg">Close All</button>
                </div>
                <div id="open-positions-list" class="space-y-3">
                    <p class="text-gray-400">No open positions for this challenge.</p>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-end p-2">
                <button id="auth-modal-close-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6">
                <!-- Tabs -->
                <div class="flex border-b border-gray-700">
                    <button id="login-tab-btn" class="flex-1 py-2 text-lg font-semibold border-b-2 border-indigo-500 text-white">Login</button>
                    <button id="register-tab-btn" class="flex-1 py-2 text-lg font-semibold border-b-2 border-transparent text-gray-400">Register</button>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="mt-6 space-y-4">
                    <input type="text" id="login-username" placeholder="Username" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="login-password" placeholder="Password" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="login-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Login</button>
                </div>

                <!-- Register Form -->
                <div id="register-form" class="mt-6 space-y-4 hidden">
                    <input type="text" id="register-username" placeholder="Username" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password" placeholder="Password" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="register-submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Create Account</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Custom Info Modal -->
    <div id="custom-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95">
            <p id="modal-message" class="text-white text-lg mb-4"></p>
            <button id="modal-close-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>
    
    <script type="module">
        // --- IMPORTANT: PASTE YOUR FINNHUB API KEY HERE ---
        // Get a free key from https://finnhub.io/register
        const FINNHUB_API_KEY = 'd1hp2f1r01qsvr2bhqh0d1hp2f1r01qsvr2bhqhg'; 

        let currentUser = null; // Will hold user info and JWT
        let tradingViewWidget = null;
        let leaderboardChart = null;
        let challengeDetailUnsubscribe = null;
        let finnhubSymbol = 'AAPL'; // Symbol for Finnhub API
        let tradingViewSymbol = 'AAPL'; // Symbol for TradingView Widget

        // DOM Elements
        const loginBtn = document.getElementById('login-btn');
        const loginBtnMobile = document.getElementById('login-btn-mobile');
        const usernameDisplay = document.getElementById('username-display');
        const friendCodeDisplay = document.getElementById('friend-code-display');
        const addFriendBtn = document.getElementById('add-friend-btn');
        const friendCodeInput = document.getElementById('friend-code-input');
        const friendsList = document.getElementById('friends-list');
        const createChallengeBtn = document.getElementById('create-challenge-btn');
        const challengesList = document.getElementById('challenges-list');
        const dashboardChallengesList = document.getElementById('dashboard-challenges-list');
        const dashboardJoinedCount = document.getElementById('dashboard-joined-count');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const joinByCodeBtn = document.getElementById('join-by-code-btn');
        const challengeCodeInput = document.getElementById('challenge-code-input');
        
        // Trade Page Elements
        const tradeChallengeSelect = document.getElementById('trade-challenge-select');
        const tradeEquity = document.getElementById('trade-equity');
        const symbolInput = document.getElementById('symbol-input');
        const lotSizeInput = document.getElementById('lot-size-input');
        const stopLossInput = document.getElementById('stop-loss-input');
        const takeProfitInput = document.getElementById('take-profit-input');
        const buyBtn = document.getElementById('buy-btn');
        const sellBtn = document.getElementById('sell-btn');
        const openPositionsList = document.getElementById('open-positions-list');
        const closeAllBtn = document.getElementById('close-all-btn');
        const websocketStatus = document.getElementById('websocket-status');

        // Challenge Detail Elements
        const backToChallengesBtn = document.getElementById('back-to-challenges-btn');
        const challengeDetailTitle = document.getElementById('challenge-detail-title');
        const challengeDetailInfo = document.getElementById('challenge-detail-info');
        const leaderboardFilter = document.getElementById('leaderboard-filter');

        // Auth Modal Elements
        const authModal = document.getElementById('auth-modal');
        const authModalCloseBtn = document.getElementById('auth-modal-close-btn');
        const loginTabBtn = document.getElementById('login-tab-btn');
        const registerTabBtn = document.getElementById('register-tab-btn');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const registerSubmitBtn = document.getElementById('register-submit-btn');

        // Custom Info Modal Elements
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- Live Price Feed (WebSocket) ---
        const priceCache = new Map();
        
        const livePriceFeed = {
            socket: null,
            subscribedSymbols: new Set(),
            pnlInterval: null,
            connect: function() {
                if (this.socket || !FINNHUB_API_KEY || FINNHUB_API_KEY === 'YOUR_FINNHUB_API_KEY') {
                    if(!this.socket) console.warn("Finnhub API key missing. Live prices disabled.");
                    websocketStatus.querySelector('.status-light').classList.replace('bg-green-500', 'bg-red-500');
                    websocketStatus.querySelector('.status-text').textContent = "API Key Missing";
                    return;
                }
                this.socket = new WebSocket(`wss://ws.finnhub.io?token=${FINNHUB_API_KEY}`);
                
                this.socket.addEventListener('open', () => {
                    console.log('Finnhub WebSocket connected.');
                    websocketStatus.querySelector('.status-light').classList.replace('bg-red-500', 'bg-green-500');
                    websocketStatus.querySelector('.status-text').textContent = "Connected";
                    const openSymbols = [...new Set(Array.from(document.querySelectorAll('[data-symbol]')).map(el => el.dataset.symbol))];
                    openSymbols.forEach(s => this.subscribe(s));
                    this.subscribe(finnhubSymbol);
                });

                this.socket.addEventListener('message', (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'trade') {
                        data.data.forEach(trade => {
                            priceCache.set(trade.s, trade.p);
                            if (trade.s === finnhubSymbol) {
                                buyBtn.disabled = false;
                                sellBtn.disabled = false;
                                websocketStatus.querySelector('.status-text').textContent = "Connected";
                            }
                        });
                    }
                });

                this.socket.addEventListener('close', () => {
                    console.log('Finnhub WebSocket disconnected.');
                    websocketStatus.querySelector('.status-light').classList.replace('bg-green-500', 'bg-red-500');
                    websocketStatus.querySelector('.status-text').textContent = "Disconnected";
                    this.socket = null;
                });

                this.socket.addEventListener('error', (error) => {
                    console.error('WebSocket Error:', error);
                    websocketStatus.querySelector('.status-text').textContent = "Error";
                });

                if (this.pnlInterval) clearInterval(this.pnlInterval);
                this.pnlInterval = setInterval(updateAllPnl, 2000);
            },
            disconnect: function() {
                if (this.socket) {
                    this.socket.close();
                }
                if (this.pnlInterval) {
                    clearInterval(this.pnlInterval);
                    this.pnlInterval = null;
                }
            },
            subscribe: function(symbol) {
                if (this.socket && this.socket.readyState === 1 && !this.subscribedSymbols.has(symbol)) {
                    this.socket.send(JSON.stringify({'type':'subscribe', 'symbol': symbol}));
                    this.subscribedSymbols.add(symbol);
                    console.log(`Subscribed to ${symbol}`);
                }
            },
            unsubscribe: function(symbol) {
                if (this.socket && this.socket.readyState === 1 && this.subscribedSymbols.has(symbol)) {
                    this.socket.send(JSON.stringify({'type':'unsubscribe','symbol': symbol}));
                    this.subscribedSymbols.delete(symbol);
                    console.log(`Unsubscribed from ${symbol}`);
                }
            }
        };

        // --- Utility Functions ---
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            const content = modal.querySelector('.modal-content');
            if (!content) return;
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
            }, 10);
        }

        function hideModal() {
            const content = modal.querySelector('.modal-content');
            if (!content) return;
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        modalCloseBtn.addEventListener('click', hideModal);

        function initializeTradingView() {
            const container = document.getElementById('tradingview_f4a8c');
            if (!container) return;
            container.innerHTML = ''; // Clear previous widget
            tradingViewWidget = new TradingView.widget({
              "autosize": true, 
              "symbol": tradingViewSymbol, 
              "interval": "D", "timezone": "Etc/UTC",
              "theme": "dark", "style": "1", "locale": "en", "toolbar_bg": "#f1f3f6",
              "enable_publishing": false, "allow_symbol_change": true, "container_id": "tradingview_f4a8c"
            });
        }
        
        // --- Page Navigation ---
        const pages = document.querySelectorAll('.page-content');
        const navLinks = document.querySelectorAll('.nav-link');

        function showPage(pageId, context = null) {
            // Unsubscribe from real-time listeners when leaving detail page
            if (challengeDetailUnsubscribe) {
                challengeDetailUnsubscribe();
                challengeDetailUnsubscribe = null;
            }
            livePriceFeed.disconnect();

            pages.forEach(page => page.classList.add('hidden'));
            const pageToShow = document.getElementById(pageId);
            if(pageToShow) pageToShow.classList.remove('hidden');
            
            navLinks.forEach(link => link.classList.remove('bg-gray-700', 'text-white'));
            const navId = pageId.startsWith('page-challenge-detail') ? 'challenges' : pageId.split('-')[1];
            document.querySelectorAll(`[id^="nav-${navId}"]`).forEach(link => {
                link.classList.add('bg-gray-700', 'text-white');
            });

            if (pageId === 'page-trade') {
                initializeTradingView();
                livePriceFeed.connect();
            }

            if (pageId === 'page-challenge-detail' && context && context.challengeId) {
                loadChallengeDetail(context.challengeId);
            }

            mobileMenu.classList.add('hidden');
        }

        document.querySelector('header').addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            const loginButton = e.target.closest('#login-btn, #login-btn-mobile');

            if (navLink) {
                e.preventDefault();
                const pageId = `page-${navLink.dataset.page}`;
                if (pageId && document.getElementById(pageId)) {
                    showPage(pageId);
                }
                return;
            }

            if (loginButton) {
                handleAuthAction();
                return;
            }
        });
        
        mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        backToChallengesBtn.addEventListener('click', () => showPage('page-challenges'));

        // --- Authentication ---
        function updateUIForLoggedInState(user) {
            currentUser = user;
            usernameDisplay.textContent = user.username;
            friendCodeDisplay.textContent = user.friendCode;
            loginBtn.textContent = 'Logout';
            loginBtnMobile.textContent = 'Logout';
            // Placeholder for fetching user-specific data
            // listenForChallenges();
            // listenForFriends();
            showPage('page-dashboard');
        }

        function updateUIForLoggedOutState() {
            currentUser = null;
            usernameDisplay.textContent = 'Not logged in';
            friendCodeDisplay.textContent = 'N/A';
            loginBtn.textContent = 'Login';
            loginBtnMobile.textContent = 'Login';
            // Clear all dynamic data
            friendsList.innerHTML = '<li class="text-gray-400">Login to see friends.</li>';
            challengesList.innerHTML = '<p class="text-gray-400">Login to see challenges.</p>';
            dashboardChallengesList.innerHTML = '<p class="text-gray-400">Login to see your challenges.</p>';
            showPage('page-dashboard');
        }

        function handleAuthAction() {
            if (currentUser) {
                currentUser = null;
                updateUIForLoggedOutState();
                showModal('You have been logged out.');
            } else {
                authModal.classList.remove('hidden');
            }
        }
        
        authModalCloseBtn.addEventListener('click', () => authModal.classList.add('hidden'));

        loginTabBtn.addEventListener('click', () => {
            loginTabBtn.classList.add('border-indigo-500', 'text-white');
            loginTabBtn.classList.remove('border-transparent', 'text-gray-400');
            registerTabBtn.classList.add('border-transparent', 'text-gray-400');
            registerTabBtn.classList.remove('border-indigo-500', 'text-white');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        });

        registerTabBtn.addEventListener('click', () => {
            registerTabBtn.classList.add('border-indigo-500', 'text-white');
            registerTabBtn.classList.remove('border-transparent', 'text-gray-400');
            loginTabBtn.classList.add('border-transparent', 'text-gray-400');
            loginTabBtn.classList.remove('border-indigo-500', 'text-white');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        });

        async function handleRegister() {
            const username = registerUsernameInput.value.trim();
            const password = registerPasswordInput.value;
            
            try {
                const response = await fetch('/.netlify/functions/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });
                
                const contentType = response.headers.get("content-type");
                if (!response.ok) {
                    let errorMessage = 'Registration failed.';
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } else {
                        errorMessage = await response.text();
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                showModal(data.message || "Registration successful!");
                loginTabBtn.click();
                loginUsernameInput.value = username;
                loginPasswordInput.value = '';

            } catch (error) {
                console.error("Registration Error:", error);
                showModal(`Registration failed: ${error.message}`);
            }
        }
        registerSubmitBtn.addEventListener('click', handleRegister);

        async function handleLogin() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value;
            if (!username || !password) return showModal("Please enter a username and password.");

            try {
                const response = await fetch('/.netlify/functions/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                const contentType = response.headers.get("content-type");
                if (!response.ok) {
                    let errorMessage = 'Login failed.';
                     if (contentType && contentType.indexOf("application/json") !== -1) {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } else {
                        errorMessage = await response.text();
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                authModal.classList.add('hidden');
                showModal(data.message);
                updateUIForLoggedInState(data.user);

            } catch (error) {
                console.error("Login Error:", error);
                showModal(`Login failed: ${error.message}`);
            }
        }
        loginSubmitBtn.addEventListener('click', handleLogin);


        // --- User Profile & Friends ---
        // These functions will be re-implemented once the API endpoints are ready.
        function setupUserProfile(user) {
            currentUser = user;
            usernameDisplay.textContent = user.username;
            friendCodeDisplay.textContent = user.friendCode;
        }
        function addFriend() { showModal("This feature is coming soon!"); }
        function listenForFriends() {}

        // --- Challenges ---
        function generateChallengeCode() {
            return Math.random().toString(36).substring(2, 12).toUpperCase();
        }

        async function createChallenge() {
            if (!currentUser) return showModal('You must be logged in to create a challenge.');

            const payload = {
                startAmount: parseInt(document.getElementById('challenge-sum').value),
                timeLimit: parseInt(document.getElementById('time-limit').value),
                maxLossPercent: parseInt(document.getElementById('max-loss').value),
            };

            try {
                const response = await fetch('/.netlify/functions/create-challenge', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Failed to create challenge.');

                showModal(data.message);
                fetchAndRenderChallenges();
                showPage('page-dashboard');

            } catch (error) {
                console.error("Create Challenge Error:", error);
                showModal(`Error: ${error.message}`);
            }
        }
        createChallengeBtn.addEventListener('click', createChallenge);

        async function fetchAndRenderChallenges() {
            if(!currentUser) return;
            
            try {
                const response = await fetch('/.netlify/functions/get-challenges');
                if (!response.ok) throw new Error('Could not fetch challenges.');
                const challenges = await response.json();

                challengesList.innerHTML = '';
                dashboardChallengesList.innerHTML = '';
                let userChallenges = [];
                let activeTradeableChallenges = [];

                if(challenges.length === 0){
                    challengesList.innerHTML = '<p class="text-gray-400">No public challenges. Create one!</p>';
                } else {
                    challenges.forEach(challenge => {
                        const challengeEl = renderChallenge(challenge, challenge.id);
                        challengesList.appendChild(challengeEl);
                        
                        if (challenge.participants.some(p => p.uid === currentUser.id)) {
                            userChallenges.push(challenge);
                            if (challenge.status === 'active') {
                                activeTradeableChallenges.push(challenge);
                            }
                        }
                    });
                }
                
                dashboardJoinedCount.textContent = userChallenges.length;
                if (userChallenges.length > 0) {
                     userChallenges.forEach(c => {
                        const el = renderChallenge(c, c.id);
                        dashboardChallengesList.appendChild(el);
                     });
                } else {
                    dashboardChallengesList.innerHTML = '<p class="text-gray-400">You have not joined any challenges yet.</p>';
                }

                if (activeTradeableChallenges.length > 0) {
                    tradeChallengeSelect.innerHTML = '';
                    activeTradeableChallenges.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = `Code: ${c.challenge_code} ($${c.start_amount.toLocaleString()})`;
                        tradeChallengeSelect.appendChild(option);
                    });
                    tradeChallengeSelect.dispatchEvent(new Event('change'));
                }

            } catch(error) {
                console.error("Fetch Challenges Error:", error);
                showModal(error.message);
            }
        }

        function renderChallenge(challenge, challengeId) {
            const el = document.createElement('div');
            el.className = 'bg-gray-700 p-4 rounded-lg';
            
            const isCreator = challenge.creator_id === currentUser.id;
            const isParticipant = challenge.participants.some(p => p.uid === currentUser.id);
            let statusColor = 'text-yellow-400';
            if (challenge.status === 'active') statusColor = 'text-green-400';
            if (challenge.status === 'finished') statusColor = 'text-gray-400';

            const details = `
                <div class="flex justify-between items-start">
                    <div>
                        <p><strong>Amount:</strong> $${Number(challenge.start_amount).toLocaleString()}</p>
                        <p><strong>Time Limit:</strong> ${challenge.time_limit_days} days</p>
                        <p><strong>Participants:</strong> ${challenge.participants.length}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${statusColor}">${challenge.status.toUpperCase()}</p>
                        <p class="text-xs text-gray-400 mt-1">Creator: ${challenge.creator_username || '...'} </p>
                    </div>
                </div>
                <div class="mt-3 bg-gray-800 p-2 rounded-md text-center cursor-pointer" onclick="navigator.clipboard.writeText('${challenge.challenge_code}')">
                    <span class="text-sm text-gray-400">Code: </span>
                    <span class="font-mono tracking-widest">${challenge.challenge_code}</span>
                </div>
            `;
            
            const actions = document.createElement('div');
            actions.className = 'mt-4 flex gap-2 flex-wrap';

            // View Details Button
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'View Details';
            viewBtn.className = 'flex-grow bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg';
            viewBtn.onclick = () => showPage('page-challenge-detail', { challengeId: challengeId });
            actions.appendChild(viewBtn);


            if (challenge.status === 'pending') {
                if (isCreator) {
                    const startBtn = document.createElement('button');
                    startBtn.textContent = 'Start';
                    startBtn.className = 'flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg';
                    startBtn.onclick = () => startChallenge(challengeId, challenge.participants, challenge.startAmount);
                    actions.appendChild(startBtn);
                }
                if (!isParticipant) {
                    const joinBtn = document.createElement('button');
                    joinBtn.textContent = 'Join';
                    joinBtn.className = 'flex-grow bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg';
                    joinBtn.onclick = () => joinChallenge(challengeId);
                    actions.appendChild(joinBtn);
                }
            }

            el.innerHTML = details;
            el.appendChild(actions);
            return el;
        }
        
        function joinChallenge(challengeId) { showModal("This feature is coming soon!"); }
        function joinChallengeByCode() { showModal("This feature is coming soon!"); }
        joinByCodeBtn.addEventListener('click', joinChallengeByCode);
        function startChallenge(challengeId, participants, startAmount) {}

        // --- Challenge Detail Page & Chart ---
        function loadChallengeDetail(challengeId) {}
        function renderLeaderboard(portfolioData) {}
        function renderLeaderboardFilter(portfolioData) {}


        // --- Trading Logic ---
        function selectChallengeToTrade() {}
        tradeChallengeSelect.addEventListener('change', selectChallengeToTrade);

        function renderOpenPositions(trades, challengeId) {}
        function calculatePnl(trade, currentPrice) {}
        async function updateAllPnl() {}
        async function placeTrade(tradeType) { showModal("This feature is coming soon!"); }
        async function updateTradeSlTp(challengeId, tradeId, stopLoss, takeProfit) {}
        async function closeTrade(challengeId, tradeId) {}
        async function closeAllPositions() {}

        buyBtn.addEventListener('click', () => placeTrade('buy'));
        sellBtn.addEventListener('click', () => placeTrade('sell'));
        closeAllBtn.addEventListener('click', closeAllPositions);
        symbolInput.addEventListener('change', (e) => {
            const newSymbol = e.target.value.trim().toUpperCase();
            if(newSymbol) {
                livePriceFeed.unsubscribe(finnhubSymbol);
                
                if (newSymbol.length === 6 && !newSymbol.includes(':')) {
                    finnhubSymbol = `OANDA:${newSymbol.slice(0,3)}_${newSymbol.slice(3)}`;
                    tradingViewSymbol = `OANDA:${newSymbol.slice(0,3)}${newSymbol.slice(3)}`;
                } else {
                    finnhubSymbol = newSymbol;
                    tradingViewSymbol = newSymbol;
                }
                
                symbolInput.value = tradingViewSymbol;
                initializeTradingView();
                livePriceFeed.subscribe(finnhubSymbol);
                
                buyBtn.disabled = true;
                sellBtn.disabled = true;
                websocketStatus.querySelector('.status-text').textContent = "Waiting for price...";
            }
        });


        // Initial load
        showPage('page-dashboard');
    </script>
</body>
</html>
